var UUID=function(){for(var n={},i=[],e=0;e<256;e++)i[e]=(e<16?"0":"")+e.toString(16);return n.generate=function(){var n=4294967295*Math.random()|0,e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,o=4294967295*Math.random()|0;return i[255&n]+i[n>>8&255]+i[n>>16&255]+i[n>>24&255]+"-"+i[255&e]+i[e>>8&255]+"-"+i[e>>16&15|64]+i[e>>24&255]+"-"+i[63&t|128]+i[t>>8&255]+"-"+i[t>>16&255]+i[t>>24&255]+i[255&o]+i[o>>8&255]+i[o>>16&255]+i[o>>24&255]},n}(),SignHandler=function(n,e){return new SignHandler.fn.init(n,e)};SignHandler.fn=SignHandler.prototype={init:function(n,i){function r(){return Math.floor((new Date).getTime()/1e3)}var c=this;c.delegate=n,c.hub={},null!=i&&""!=i||(i="SignHandler");c.CreateHub=function(n,e,t,o){var l=c.hub[n];return null==l&&null!=(e=$.hubConnection(e,{qs:t,logging:!1,useDefaultPath:!0}).createHubProxy(n))&&((l=c.hub[n]=$.extend({name:n,connectionId:"",isAutoStop:!0,isRuning:!1,isConnected:!1,time:{start:0,stop:0,invoke:0},connectedTimeOut:10,delegate:null!=c.delegate?c.delegate[n]:void 0,invokeStack:[],callback:{},proxy:e},o)).start=function(n,e){l.isRuning=!0,l.time.start=r(),l.proxy.connection.start(n,e)},l.stop=function(){l.isRuning=l.isConnected=!1,l.time.stop=r(),l.proxy.connection.stop(!0,!0)},l.log=function(n){console.log(i+"["+l.name+"]["+l.connectionId+"]"+n)},l.loop=function(a){setTimeout(function(){try{var n,e,t,o,i=0,c=r()-a.connectedTimeOut;for(n in a.callback)0!=i||0<(e=a.callback[n]).timestamp&&e.timestamp<c&&(delete a.callback[n],l.log("callback["+k+"][s:"+e.timestamp+",n:"+(c+a.connectedTimeOut)+"] timeout...")),i++;0<a.invokeStack.length?a.isRuning?a.isConnected&&i<4&&(t=r(),(o=a.invokeStack.shift()).timestamp=t,a.time.invoke=t,null!=o.uuid&&(a.callback[o.uuid]=o),a.proxy.invoke.apply(a.proxy,o.args)):a.start():a.isAutoStop&&a.isRuning&&0<a.time.start&&a.time.start<c&&a.time.invoke<c&&0==i&&a.stop()}catch(n){}a.loop(a)},300)},l.invoke=function(){for(var t=UUID.generate().replace(/-/g,""),o=[arguments[0],t],n=1;n<arguments.length;n++)o.push(arguments[n]);return new Promise(function(n,e){l.invokeStack.push({uuid:t,args:o,timestamp:0,resolve:n,reject:e})})},l.invokeNoUUid=function(){for(var t=[],n=0;n<arguments.length;n++)t.push(arguments[n]);return new Promise(function(n,e){l.invokeStack.push({args:t,timestamp:0,resolve:n,reject:e})})},$(e.connection).bind({onReceived:function(n,e){try{var t=c.hub[e.H];if(null!=(t=null==t?c.hub[e.H.toLowerCase()]:t)){var o=void 0;try{o=t.callback[e.A[0]]}catch(n){}null!=o?(delete t.callback[e.A[0]],o.resolve.apply(o.resolve,e.A.slice(1))):null!=t.delegate&&null!=t.delegate.onReceived&&null!=e.M&&t.delegate.onReceived(t,e.M,e.A)}}catch(n){}},onStateChanged:function(n,e){switch(e.newState){case $.signalR.connectionState.connected:case $.signalR.connectionState.disconnected:for(var t in n.target.proxies){var o=c.hub[t];if(null!=o){o.isConnected=e.newState==$.signalR.connectionState.connected,o.isConnected&&(o.connectionId=o.proxy.connection.id.substring(0,8)),console.log(i+"["+t+"]["+o.connectionId+"]"+(o.isConnected?"connected":"disconnected"));try{null!=o&&null!=o.delegate&&null!=o.delegate.onStateChanged&&o.delegate.onStateChanged(o)}catch(n){}}}}}}),e.on("onEcho",function(){}),l.loop(l)),l},c.removeHub=function(t){null!=c.hub[t]&&new Promise(function(n,e){n(c.hub[t].proxy.connection.stop(!0,!0))}).then(function(n){$(c.hub[t].proxy.connection).unbind(),delete c.hub[t]})}}};